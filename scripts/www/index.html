<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ç†Šç•ªèŒ„</title>
    <!-- ä½¿ç”¨å›½å†… CDN é•œåƒåŠ é€Ÿ -->
    <script src="https://lib.baomitu.com/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://lib.baomitu.com/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://lib.baomitu.com/babel-standalone/7.22.20/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://lib.baomitu.com/lucide-static/0.321.0/font/lucide.min.css" rel="stylesheet">
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
            user-select: none;
            -webkit-user-select: none;
        }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.9); } 100% { transform: scale(1); } }
        /* é€‚é…è‹¹æœåˆ˜æµ·å± */
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-orange-50/30">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 18, className = "" }) => (
            <i className={`lucide-${name} ${className}`} style={{ fontSize: size }}></i>
        );

        const App = () => {
            // æ•°æ®æŒä¹…åŒ–ï¼šä»æœ¬åœ°å­˜å‚¨è¯»å–
            const [tomatoes, setTomatoes] = useState(() => {
                const saved = localStorage.getItem('bear_tomatoes');
                return saved ? JSON.parse(saved) : { small: 0, medium: 0, large: 0 };
            });
            const [greenTomatoes, setGreenTomatoes] = useState(() => {
                const saved = localStorage.getItem('bear_green');
                return saved ? JSON.parse(saved) : [];
            });
            const [streakCount, setStreakCount] = useState(() => Number(localStorage.getItem('bear_streak')) || 0);
            const [dailyStudyMinutes, setDailyStudyMinutes] = useState(() => Number(localStorage.getItem('bear_study_min')) || 0);
            const [lastCheckInDate, setLastCheckInDate] = useState(() => localStorage.getItem('bear_last_checkin'));

            const [activeTask, setActiveTask] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [isResting, setIsResting] = useState(false);
            const [message, setMessage] = useState("ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å‘€ï¼Œå°ç†Šï¼");
            
            const [showDev, setShowDev] = useState(false);
            const [pending, setPending] = useState(null);

            const audioRef = useRef(new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"));

            // ç›‘å¬æ•°æ®å˜åŒ–å¹¶ä¿å­˜åˆ°æœ¬åœ°
            useEffect(() => {
                localStorage.setItem('bear_tomatoes', JSON.stringify(tomatoes));
                localStorage.setItem('bear_green', JSON.stringify(greenTomatoes));
                localStorage.setItem('bear_streak', streakCount);
                localStorage.setItem('bear_study_min', dailyStudyMinutes);
                if (lastCheckInDate) localStorage.setItem('bear_last_checkin', lastCheckInDate);
            }, [tomatoes, greenTomatoes, streakCount, dailyStudyMinutes, lastCheckInDate]);

            useEffect(() => {
                let timer = null;
                if (isRunning && timeLeft > 0) {
                    timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                } else if (timeLeft === 0 && isRunning) {
                    handleComplete();
                }
                return () => clearInterval(timer);
            }, [isRunning, timeLeft]);

            useEffect(() => {
                const interval = setInterval(() => {
                    const now = Date.now();
                    setGreenTomatoes(prev => prev.filter(gt => gt.expiresAt > now));
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleComplete = () => {
                setIsRunning(false);
                audioRef.current.play().catch(() => {});
                
                if (isResting) {
                    setMessage("ä¼‘æ¯ç»“æŸï¼Œå°ç†Šç”µåŠ›æ»¡æ ¼ï¼");
                } else {
                    if (activeTask.category === 'study') setDailyStudyMinutes(d => d + activeTask.workTime);
                    setTomatoes(prev => {
                        const next = { ...prev };
                        Object.keys(activeTask.rewards || {}).forEach(k => next[k] += activeTask.rewards[k]);
                        return next;
                    });
                    setMessage(`ã€Œ${activeTask.label}ã€å®Œæˆï¼å¥–åŠ±å·²å…¥åº“ã€‚`);
                }
                setActiveTask(null);
                if (window.navigator.vibrate) window.navigator.vibrate([200, 100, 200]);
            };

            const startAction = () => {
                const { action, type } = pending;
                if (type === 'task') {
                    setActiveTask(action);
                    setTimeLeft(action.workTime * 60);
                    setIsResting(false);
                } else {
                    if (action === 'green') {
                        const copy = [...greenTomatoes].sort((a,b) => a.expiresAt - b.expiresAt);
                        copy[0].count -= 1;
                        setGreenTomatoes(copy.filter(g => g.count > 0));
                    } else {
                        setTomatoes(p => ({ ...p, [action]: p[action] - 1 }));
                    }
                    const mins = action === 'small' ? 5 : action === 'medium' ? 10 : action === 'green' ? 30 : 60;
                    setActiveTask({ label: 'ä¼‘æ¯ä¸­' });
                    setTimeLeft(mins * 60);
                    setIsResting(true);
                }
                setIsRunning(true);
                setPending(null);
                // é¢„æ¿€æ´»éŸ³é¢‘
                audioRef.current.play().then(() => { audioRef.current.pause(); }).catch(() => {});
            };

            const claimDaily = () => {
                const today = new Date().toLocaleDateString();
                const newStreak = streakCount + 1;
                setStreakCount(newStreak);
                setLastCheckInDate(today);
                setDailyStudyMinutes(0);
                
                const expiry = Date.now() + 48 * 3600 * 1000;
                if (newStreak === 30) setTomatoes(p => ({ ...p, large: p.large + 10 }));
                else if (newStreak >= 5 && newStreak <= 7) setTomatoes(p => ({ ...p, large: p.large + 1 }));
                else setGreenTomatoes(p => [...p, { id: Date.now(), expiresAt: expiry, count: 1 }]);
                
                setMessage(`æ‰“å¡æˆåŠŸï¼è¿ç»­ç¬¬ ${newStreak} å¤©ã€‚`);
                audioRef.current.play().catch(() => {});
            };

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col p-5 relative safe-top safe-bottom">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-3">
                            <div className="bg-orange-500 w-10 h-10 rounded-2xl shadow-lg flex items-center justify-center text-white">
                                <Icon name="heart" size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-orange-950 leading-none">å°ç†Šç•ªèŒ„</h1>
                                <p className="text-[10px] text-orange-400 font-bold mt-1 tracking-widest">LITTLE BEAR POMO</p>
                            </div>
                        </div>
                        <button onClick={() => setShowDev(!showDev)} className="text-slate-300 w-10 h-10 flex items-center justify-center rounded-full active:bg-orange-100"><Icon name="settings" size={20} /></button>
                    </div>

                    {/* Daily Progress */}
                    <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-orange-100 mb-6">
                        <div className="flex justify-between text-sm font-bold mb-4">
                            <span className="flex items-center gap-2 text-slate-700">
                                <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                è¿èƒœ {streakCount} å¤©
                            </span>
                            <span className="text-blue-500 bg-blue-50 px-3 py-0.5 rounded-full text-xs font-black">{Math.floor(dailyStudyMinutes)}/15m</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-700" style={{ width: `${Math.min(100, (dailyStudyMinutes/15)*100)}%` }}></div>
                            </div>
                            <button 
                                onClick={claimDaily}
                                disabled={dailyStudyMinutes < 15 || lastCheckInDate === new Date().toLocaleDateString()}
                                className={`px-5 py-2 rounded-2xl text-xs font-black transition-all ${dailyStudyMinutes >= 15 && lastCheckInDate !== new Date().toLocaleDateString() ? 'bg-orange-500 text-white shadow-lg active:scale-95' : 'bg-slate-100 text-slate-300'}`}
                            >
                                {lastCheckInDate === new Date().toLocaleDateString() ? 'å·²é¢†' : 'é¢†å¥–'}
                            </button>
                        </div>
                    </div>

                    {/* Bank */}
                    <div className="bg-white rounded-[2rem] p-6 shadow-sm mb-8 border border-orange-50">
                        <div className="flex justify-between items-center mb-5">
                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">èµ„äº§é“¶è¡Œ</span>
                            {greenTomatoes.length > 0 && <span className="text-[10px] text-emerald-500 font-bold bg-emerald-50 px-2 py-0.5 rounded-lg border border-emerald-100">ğŸ¥¦ é™æ—¶é’ç•ªèŒ„å¯ç”¨</span>}
                        </div>
                        <div className="grid grid-cols-4 gap-3">
                            {['small', 'medium', 'large'].map(t => (
                                <button key={t} onClick={() => setPending({action: t, type: 'rest'})} disabled={tomatoes[t] <= 0 || isRunning} className={`flex flex-col items-center p-3 rounded-2xl border-2 transition-all ${tomatoes[t] > 0 ? 'bg-orange-50 border-orange-100 active:scale-90' : 'bg-slate-50 opacity-30 border-transparent'}`}>
                                    <span className="text-2xl">ğŸ…</span>
                                    <span className="text-sm font-black text-orange-950 mt-1">{tomatoes[t]}</span>
                                </button>
                            ))}
                            <button onClick={() => setPending({action: 'green', type: 'rest'})} disabled={greenTomatoes.length === 0 || isRunning} className={`flex flex-col items-center p-3 rounded-2xl border-2 transition-all ${greenTomatoes.length > 0 ? 'bg-emerald-50 border-emerald-100 active:scale-90' : 'bg-slate-50 opacity-30 border-transparent'}`}>
                                <span className="text-2xl">ğŸ¥¦</span>
                                <span className="text-sm font-black text-emerald-900 mt-1">{greenTomatoes.reduce((s, g) => s + g.count, 0)}</span>
                            </button>
                        </div>
                    </div>

                    {/* Timer or List */}
                    {activeTask ? (
                        <div className="bg-white rounded-[3rem] p-10 shadow-2xl shadow-orange-200/50 border-b-[12px] border-orange-500 text-center animate-pop">
                            <div className="text-xs font-black text-orange-400 uppercase tracking-widest mb-4">{isResting ? 'Enjoying' : 'Focusing'}</div>
                            <div className="text-7xl font-black font-mono text-slate-800 mb-10 tracking-tighter tabular-nums">
                                {Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2, '0')}
                            </div>
                            <div className="flex justify-center gap-6">
                                <button onClick={() => setIsRunning(!isRunning)} className="w-20 h-20 bg-orange-500 text-white rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-transform">
                                    <Icon name={isRunning ? 'pause' : 'play'} size={32} className={isRunning ? "" : "ml-1"} />
                                </button>
                                <button onClick={() => { setIsRunning(false); setActiveTask(null); }} className="w-20 h-20 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center active:scale-90 transition-transform">
                                    <Icon name="x" size={32} />
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {[
                                { label: 'ä¸“æ³¨å­¦ä¹ ', time: 30, rewards: { large: 1, medium: 1 }, cat: 'study', icon: 'book-open', color: 'blue' },
                                { label: 'å®¶åŠ¡åŠ³åŠ¨', time: 10, rewards: { medium: 1 }, cat: 'home', icon: 'home', color: 'orange' },
                                { label: 'æ—¥å¸¸é”»ç‚¼', time: 15, rewards: { small: 2 }, cat: 'fit', icon: 'dumbbell', color: 'red' }
                            ].map((task, i) => (
                                <button key={i} onClick={() => setPending({action: { ...task, workTime: task.time }, type: 'task'})} className="w-full bg-white p-5 rounded-3xl flex justify-between items-center shadow-sm border border-transparent active:border-orange-200 active:bg-orange-50/50 transition-all">
                                    <div className="flex items-center gap-5">
                                        <div className={`p-4 bg-${task.color}-50 text-${task.color}-500 rounded-2xl`}><Icon name={task.icon} size={24} /></div>
                                        <div className="text-left">
                                            <div className="font-black text-slate-800 text-lg">{task.label}</div>
                                            <div className="text-xs text-slate-400 font-bold tracking-wider">{task.time} åˆ†é’Ÿ Â· èµšå–ç•ªèŒ„</div>
                                        </div>
                                    </div>
                                    <div className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-slate-300">
                                        <Icon name="play" size={16} />
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Message Toast */}
                    {message && !activeTask && (
                        <div className="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full text-xs font-black shadow-2xl animate-pop z-50 flex items-center gap-3">
                            <div className="w-2 h-2 bg-orange-400 rounded-full"></div>
                            {message}
                        </div>
                    )}

                    {/* Pending Dialog */}
                    {pending && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-8 z-[100]">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-xs text-center animate-pop border border-orange-100 shadow-2xl">
                                <div className="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <Icon name="play" size={32} className="ml-1" />
                                </div>
                                <h3 className="font-black text-xl text-slate-900 mb-3 tracking-tighter">å‡†å¤‡å¥½äº†å—ï¼Ÿ</h3>
                                <p className="text-sm text-slate-400 font-bold mb-8 leading-relaxed">è¡ŒåŠ¨æœŸé—´è¯·ä¿æŒå±å¹•å¼€å¯<br/>äº«å—ä¸“æ³¨çš„æ—¶åˆ»å§ï¼</p>
                                <div className="flex gap-4">
                                    <button onClick={() => setPending(null)} className="flex-1 py-4 bg-slate-100 rounded-2xl font-black text-slate-400 active:scale-95 transition-transform">å–æ¶ˆ</button>
                                    <button onClick={startAction} className="flex-1 py-4 bg-orange-500 rounded-2xl font-black text-white shadow-lg shadow-orange-200 active:scale-95 transition-transform">å¼€å¯</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Dev Menu */}
                    {showDev && (
                        <div className="fixed bottom-0 left-0 right-0 bg-slate-900 p-8 rounded-t-[3rem] text-white z-[110] animate-pop shadow-2xl border-t border-slate-800">
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="text-xs font-black uppercase text-slate-500 tracking-[0.2em]">å¼€å‘è€…å®éªŒå®¤</h4>
                                <button onClick={() => setShowDev(false)} className="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800"><Icon name="x" size={14} /></button>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => setTimeLeft(0)} className="bg-slate-800 border border-slate-700 py-4 rounded-2xl font-black text-xs active:bg-slate-700">âš¡ ç¬é—´å®Œæˆ</button>
                                <button onClick={() => setDailyStudyMinutes(15)} className="bg-slate-800 border border-slate-700 py-4 rounded-2xl font-black text-xs active:bg-slate-700">ğŸ¯ æ‰“å¡è¿›åº¦</button>
                                <button onClick={() => setTomatoes(p => ({...p, large: p.large + 10}))} className="bg-orange-600 py-4 rounded-2xl font-black text-xs active:bg-orange-500">â• 10å¤§ç•ªèŒ„</button>
                                <button onClick={() => {
                                    if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                                        localStorage.clear();
                                        window.location.reload();
                                    }
                                }} className="bg-red-900/40 border border-red-900/50 py-4 rounded-2xl font-black text-xs text-red-400">ğŸ”¥ æ ¼å¼åŒ–</button>
                            </div>
                            <p className="text-center text-[10px] text-slate-600 mt-6 font-bold uppercase tracking-widest">Little Bear Pomo v1.3.2 Domestic</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>